#!/usr/bin/env bash
# This script configures Nginx on an Ubuntu server to add a custom HTTP header.
# The header 'X-Served-By' will be set to the hostname of the server.

# Ensure the script is run as root or with sudo privileges
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" 1>&2
    exit 1
fi

# Update and install Nginx if it's not already installed
echo "Updating package lists..."
apt-get update
echo "Installing Nginx..."
apt-get install -y nginx

# Check if Nginx is installed successfully
if ! command -v nginx &> /dev/null
then
    echo "Nginx could not be installed. Please check your package manager and try again."
    exit 1
fi

# Retrieve the hostname of the machine
HOSTNAME=$(hostname)

# Configure Nginx to add the custom header
echo "Configuring Nginx..."
cat <<EOF > /etc/nginx/sites-available/default
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    # Add the custom header with the hostname of the server
    add_header X-Served-By \$HOSTNAME;

    root /var/www/html;

    index index.html index.htm index.nginx-debian.html;

    server_name _;

    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOF

# Check if the Nginx configuration is okay
echo "Testing Nginx configuration..."
nginx -t

# Reload Nginx to apply the changes
echo "Reloading Nginx..."
systemctl restart nginx

# Confirm the service has restarted successfully
if systemctl status nginx | grep -q 'active (running)'; then
    echo "Nginx is running with the new configuration."
else
    echo "Failed to restart Nginx. Please check the status using 'systemctl status nginx'."
    exit 1
fi

echo "Nginx has been configured successfully."
